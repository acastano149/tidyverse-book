# Verbos B√°sicos II: Transformaci√≥n de Datos

Este cap√≠tulo traduce `.assign()`, `.rename()` de pandas a `mutate()`, `rename()`, `case_when()` de dplyr.

```{webr-r}
library(tidyverse)

atletas <- tibble(
  JugadorID = sprintf("ATL_%03d", 1:15),
  Nombre = c('Garc√≠a', 'L√≥pez', 'Mart√≠nez', 'S√°nchez', 'Fern√°ndez', 
             'Gonz√°lez', 'Rodr√≠guez', 'P√©rez', 'G√≥mez', 'Ruiz',
             'D√≠az', 'Moreno', '√Ålvarez', 'Jim√©nez', 'Romero'),
  Posicion = c('Delantero', 'Mediocentro', 'Defensa', 'Portero', 'Delantero',
              'Mediocentro', 'Defensa', 'Delantero', 'Mediocentro', 'Defensa',
              'Portero', 'Delantero', 'Mediocentro', 'Defensa', 'Extremo'),
  Edad = c(25, 28, 23, 31, 22, 27, 29, 24, 26, 30, 33, 21, 25, 28, 23),
  Altura_cm = c(178, 175, 182, 188, 176, 180, 185, 173, 177, 184, 190, 172, 179, 183, 175),
  Peso_kg = c(75, 72, 80, 85, 70, 76, 82, 68, 74, 81, 87, 67, 73, 79, 71),
  VO2max = c(58.5, 62.1, 55.0, 48.2, 60.5, 59.0, 54.5, 61.0, 57.5, 53.0, 46.0, 63.0, 58.0, 55.5, 59.5),
  FC_Max = c(195, 188, 192, 185, 198, 190, 186, 196, 191, 184, 180, 200, 193, 187, 197),
  FC_Reposo = c(52, 48, 55, 58, 50, 51, 54, 49, 53, 56, 60, 47, 52, 55, 50),
  VelocidadMax_kmh = c(32.5, 31.0, 30.2, 28.5, 33.8, 31.5, 29.8, 34.2, 30.5, 29.0, 27.5, 35.0, 31.2, 29.5, 33.0)
)

cat("‚úÖ Datos cargados:", nrow(atletas), "atletas\n")
```

***

## 1. Crear Nuevas Columnas con mutate()

### Ejemplo 1.1: Columna calculada simple

**En Python:**
```python
atletas.assign(IMC = lambda x: x['Peso_kg'] / (x['Altura_cm']/100)**2)
```

**En R:**
```{webr-r}
atletas %>%
  mutate(IMC = Peso_kg / (Altura_cm / 100)^2) %>%
  select(Nombre, Peso_kg, Altura_cm, IMC) %>%
  head()
```

### Ejemplo 1.2: M√∫ltiples columnas

```{webr-r}
atletas %>%
  mutate(
    IMC = Peso_kg / (Altura_cm / 100)^2,
    FC_Reserva = FC_Max - FC_Reposo,
    Altura_m = Altura_cm / 100
  ) %>%
  select(Nombre, IMC, FC_Reserva, Altura_m) %>%
  head()
```

---

### üß† Pr√°ctica 1.1

Crea una columna `VelocidadMax_ms` que convierta la velocidad de km/h a m/s (dividir por 3.6).

```{webr-r}
# Pista: mutate(nueva_col = col_existente / 3.6)

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  mutate(VelocidadMax_ms = VelocidadMax_kmh / 3.6) %>%
  select(Nombre, VelocidadMax_kmh, VelocidadMax_ms) %>%
  head()
```
:::

***

## 2. Renombrar Columnas

### Ejemplo 2.1: rename()

**En Python:** `atletas.rename(columns={'Nombre': 'Jugador'})`

**En R:**
```{webr-r}
atletas %>%
  rename(Jugador = Nombre) %>%
  head(3)
```

::: callout-note
La sintaxis es `nombre_nuevo = nombre_viejo` ‚Äî al rev√©s que en Python.
:::

### Ejemplo 2.2: Renombrar m√∫ltiples columnas

```{webr-r}
atletas %>%
  rename(
    Jugador = Nombre,
    Rol = Posicion,
    A√±os = Edad
  ) %>%
  select(Jugador, Rol, A√±os) %>%
  head()
```

---

***

## 3. L√≥gica Condicional: case_when()

### Ejemplo 3.1: Categor√≠as basadas en valores

**En Python:**
```python
import numpy as np
atletas.assign(
    Categoria_Edad = np.where(atletas['Edad'] < 25, 'Joven',
                              np.where(atletas['Edad'] <= 30, 'Prime', 'Veterano'))
)
```

**En R:**
```{webr-r}
atletas %>%
  mutate(
    Categoria_Edad = case_when(
      Edad < 25  ~ "Joven",
      Edad <= 30 ~ "Prime",
      TRUE       ~ "Veterano"
    )
  ) %>%
  select(Nombre, Edad, Categoria_Edad) %>%
  head(10)
```

**¬øC√≥mo funciona?** `case_when()` eval√∫a condiciones en orden. `TRUE` captura "todo lo dem√°s" (como `else`).

### Ejemplo 3.2: Clasificaci√≥n de rendimiento

```{webr-r}
atletas %>%
  mutate(
    Nivel_VO2 = case_when(
      VO2max >= 60 ~ "√âlite",
      VO2max >= 55 ~ "Alto",
      VO2max >= 50 ~ "Medio",
      TRUE         ~ "Bajo"
    )
  ) %>%
  count(Nivel_VO2)
```

---

### üß† Pr√°ctica 3.1

Crea una columna `Perfil_Velocidad` con las categor√≠as:
- "Explosivo": VelocidadMax_kmh >= 33
- "R√°pido": VelocidadMax_kmh >= 30
- "Normal": resto

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  mutate(
    Perfil_Velocidad = case_when(
      VelocidadMax_kmh >= 33 ~ "Explosivo",
      VelocidadMax_kmh >= 30 ~ "R√°pido",
      TRUE                   ~ "Normal"
    )
  ) %>%
  select(Nombre, VelocidadMax_kmh, Perfil_Velocidad)
```
:::

***

## 4. Modificar Columnas Existentes

### Ejemplo 4.1: Actualizar valores

```{webr-r}
atletas %>%
  mutate(
    # Redondear VO2max a entero
    VO2max = round(VO2max),
    # Convertir altura a metros
    Altura_cm = Altura_cm / 100
  ) %>%
  select(Nombre, VO2max, Altura_cm) %>%
  head()
```

### Ejemplo 4.2: Modificar condicionalmente

```{webr-r}
atletas %>%
  mutate(
    # Corregir un valor espec√≠fico
    VO2max = if_else(Nombre == "D√≠az", VO2max + 5, VO2max)
  ) %>%
  filter(Nombre == "D√≠az") %>%
  select(Nombre, VO2max)
```

---

***

## üèÜ Mini-Proyecto: Feature Engineering

### Pregunta 1: √çndice de Masa Corporal
Calcula el IMC y clasif√≠calo: "Normal" (< 25), "Sobrepeso" (25-30), "Obesidad" (> 30).

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  mutate(
    IMC = Peso_kg / (Altura_cm / 100)^2,
    Categoria_IMC = case_when(
      IMC < 25 ~ "Normal",
      IMC <= 30 ~ "Sobrepeso",
      TRUE ~ "Obesidad"
    )
  ) %>%
  select(Nombre, IMC, Categoria_IMC)
```
:::

### Pregunta 2: √çndice de Rendimiento Compuesto
Crea un √≠ndice que combine VO2max normalizado (0-1) y velocidad normalizada (0-1).

```{webr-r}
# Pista: Para normalizar: (valor - min) / (max - min)

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  mutate(
    VO2_norm = (VO2max - min(VO2max)) / (max(VO2max) - min(VO2max)),
    Vel_norm = (VelocidadMax_kmh - min(VelocidadMax_kmh)) / 
               (max(VelocidadMax_kmh) - min(VelocidadMax_kmh)),
    Indice_Rendimiento = (VO2_norm + Vel_norm) / 2
  ) %>%
  select(Nombre, VO2_norm, Vel_norm, Indice_Rendimiento) %>%
  arrange(desc(Indice_Rendimiento))
```
:::

### Pregunta 3: Etiquetado por Posici√≥n y Edad
Crea una etiqueta que combine posici√≥n y categor√≠a de edad (ej: "Delantero_Joven").

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  mutate(
    Cat_Edad = case_when(
      Edad < 25 ~ "Joven",
      Edad <= 30 ~ "Prime",
      TRUE ~ "Veterano"
    ),
    Etiqueta = paste(Posicion, Cat_Edad, sep = "_")
  ) %>%
  select(Nombre, Posicion, Edad, Cat_Edad, Etiqueta)
```
:::

---

## Resumen

| Operaci√≥n | Python (Pandas) | R (Tidyverse) |
|-----------|-----------------|---------------|
| Nueva columna | `.assign(col = ...)` | `mutate(col = ...)` |
| Renombrar | `.rename(columns={...})` | `rename(nuevo = viejo)` |
| Condicional simple | `np.where(cond, v1, v2)` | `if_else(cond, v1, v2)` |
| M√∫ltiples condiciones | `np.select([conds], [vals])` | `case_when(cond ~ val, ...)` |
