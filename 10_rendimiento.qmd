# Rendimiento y Optimizaci√≥n

Este cap√≠tulo cubre t√©cnicas para trabajar eficientemente con datos grandes en R.

```{webr-r}
library(tidyverse)

# Simular dataset grande
set.seed(42)
n <- 10000

gps_grande <- tibble(
  JugadorID = sample(sprintf("ATL_%03d", 1:50), n, replace = TRUE),
  Fecha = sample(seq.Date(as.Date("2023-01-01"), as.Date("2024-12-31"), by = "day"), n, replace = TRUE),
  Distancia = rnorm(n, 8000, 2000),
  HSR = rnorm(n, 500, 150),
  Sprints = rpois(n, 15),
  RPE = sample(1:10, n, replace = TRUE)
)

cat("‚úÖ Dataset grande creado:", nrow(gps_grande), "filas\n")
```

***

## 1. Vectorizaci√≥n vs Loops

### Ejemplo 1.1: Evitar loops

**‚ùå Lento (loop):**
```r
# NO hacer esto
for (i in 1:nrow(gps_grande)) {
  gps_grande$HSR_pct[i] <- gps_grande$HSR[i] / gps_grande$Distancia[i] * 100
}
```

**‚úÖ R√°pido (vectorizado):**
```{webr-r}
gps_grande <- gps_grande %>%
  mutate(HSR_pct = HSR / Distancia * 100)

head(gps_grande)
```

---

## 2. Operaciones Eficientes

### Ejemplo 2.1: across() para m√∫ltiples columnas

```{webr-r}
# Aplicar funci√≥n a varias columnas a la vez
gps_grande %>%
  summarise(across(c(Distancia, HSR, Sprints), 
                   list(media = mean, sd = sd)))
```

### Ejemplo 2.2: Filtrar antes de operar

```{webr-r}
# Primero filtrar, luego calcular (m√°s eficiente)
gps_grande %>%
  filter(RPE >= 7) %>%  # Reducir datos primero
  group_by(JugadorID) %>%
  summarise(Distancia_alta_carga = mean(Distancia)) %>%
  head()
```

---

## 3. data.table para Big Data

Para datasets muy grandes (millones de filas), `data.table` es m√°s r√°pido que dplyr.

::: callout-note
## Comparaci√≥n de Sintaxis
| dplyr | data.table |
|-------|-----------|
| `filter(x > 5)` | `[x > 5]` |
| `select(a, b)` | `[, .(a, b)]` |
| `mutate(c = a+b)` | `[, c := a+b]` |
| `group_by() %>% summarise()` | `[, .(mean = mean(x)), by = y]` |
:::

---

## 4. Medici√≥n de Tiempo

```{webr-r}
# Medir tiempo de ejecuci√≥n
system.time({
  resultado <- gps_grande %>%
    group_by(JugadorID) %>%
    summarise(
      n_sesiones = n(),
      dist_total = sum(Distancia),
      hsr_media = mean(HSR)
    )
})
```

---

## üèÜ Mini-Proyecto: Optimizaci√≥n

### Pregunta 1: Agregaci√≥n Eficiente
Calcula estad√≠sticas por jugador y mes de forma eficiente.

```{webr-r}
# Pista: Crea columna de mes, luego agrupa

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
gps_grande %>%
  mutate(Mes = lubridate::month(Fecha)) %>%
  group_by(JugadorID, Mes) %>%
  summarise(
    Sesiones = n(),
    Dist_media = mean(Distancia),
    .groups = "drop"
  ) %>%
  head(10)
```
:::

---

## Resumen

| Pr√°ctica | Recomendaci√≥n |
|----------|---------------|
| Loops | Evitar, usar vectorizaci√≥n |
| M√∫ltiples operaciones | `across()` |
| Datos grandes | Filtrar temprano, usar `data.table` |
| Medir rendimiento | `system.time()` |
