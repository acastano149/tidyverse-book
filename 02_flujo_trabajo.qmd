# El Pipe: De Method Chaining a %>%

En Pandas encadenas m√©todos con `.method().method()`. En R/Tidyverse usamos el **pipe** `%>%` (o `|>` en R moderno). Este cap√≠tulo te ense√±a a pensar en pipes.

```{webr-r}
library(tidyverse)

# Dataset atletas
atletas <- tibble(
  JugadorID = sprintf("ATL_%03d", 1:15),
  Nombre = c('Garc√≠a', 'L√≥pez', 'Mart√≠nez', 'S√°nchez', 'Fern√°ndez', 
             'Gonz√°lez', 'Rodr√≠guez', 'P√©rez', 'G√≥mez', 'Ruiz',
             'D√≠az', 'Moreno', '√Ålvarez', 'Jim√©nez', 'Romero'),
  Posicion = c('Delantero', 'Mediocentro', 'Defensa', 'Portero', 'Delantero',
              'Mediocentro', 'Defensa', 'Delantero', 'Mediocentro', 'Defensa',
              'Portero', 'Delantero', 'Mediocentro', 'Defensa', 'Extremo'),
  Edad = c(25, 28, 23, 31, 22, 27, 29, 24, 26, 30, 33, 21, 25, 28, 23),
  VO2max = c(58.5, 62.1, 55.0, 48.2, 60.5, 59.0, 54.5, 61.0, 57.5, 53.0, 46.0, 63.0, 58.0, 55.5, 59.5),
  VelocidadMax_kmh = c(32.5, 31.0, 30.2, 28.5, 33.8, 31.5, 29.8, 34.2, 30.5, 29.0, 27.5, 35.0, 31.2, 29.5, 33.0),
  YoYo_IR1_m = c(2120, 2400, 1840, 1280, 2280, 2200, 1720, 2360, 2040, 1680, 1120, 2520, 2080, 1800, 2240)
)

cat("‚úÖ Datos cargados:", nrow(atletas), "atletas\n")
```

***

## 1. El Problema: C√≥digo Anidado

Sin pipes, el c√≥digo R se vuelve dif√≠cil de leer porque hay que leer "de dentro hacia afuera".

### Ejemplo 1.1: Sin pipe (c√≥digo anidado)

```{webr-r}
# ‚ùå Dif√≠cil de leer: de dentro hacia afuera
resultado <- head(arrange(filter(atletas, Posicion == "Delantero"), desc(VO2max)), 3)
print(resultado)
```

### Ejemplo 1.2: Con pipe (c√≥digo lineal)

**En Python (Pandas):**
```python
(atletas
    .query("Posicion == 'Delantero'")
    .sort_values('VO2max', ascending=False)
    .head(3))
```

**En R (Tidyverse):**
```{webr-r}
# ‚úÖ F√°cil de leer: paso a paso
atletas %>%
  filter(Posicion == "Delantero") %>%
  arrange(desc(VO2max)) %>%
  head(3)
```

**¬øQu√© hace el pipe?** Toma el resultado de la izquierda y lo pasa como **primer argumento** a la funci√≥n de la derecha.

---

## 2. Sintaxis del Pipe

### Ejemplo 2.1: Pipe paso a paso

```{webr-r}
# Esto:
atletas %>% filter(Edad > 25)

# Es equivalente a:
filter(atletas, Edad > 25)
```

### Ejemplo 2.2: M√∫ltiples pasos

```{webr-r}
atletas %>%
  filter(Edad > 25) %>%          # Paso 1: Filtrar edad > 25
  select(Nombre, Posicion) %>%   # Paso 2: Quedarse con 2 columnas
  arrange(Nombre)                 # Paso 3: Ordenar alfab√©ticamente
```

---

### üß† Pr√°ctica 2.1: Tu primer pipeline

Escribe un pipeline que:
1. Filtre atletas con VelocidadMax_kmh > 30
2. Seleccione Nombre y VelocidadMax_kmh
3. Ordene por velocidad descendente

```{webr-r}
# Pista: datos %>% filter(...) %>% select(...) %>% arrange(desc(...))

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  filter(VelocidadMax_kmh > 30) %>%
  select(Nombre, VelocidadMax_kmh) %>%
  arrange(desc(VelocidadMax_kmh))
```
:::

***

## 3. Pipe Nativo vs magrittr

R 4.1+ introdujo el pipe nativo `|>`. El tidyverse usa `%>%` de magrittr.

### Ejemplo 3.1: Comparaci√≥n

```{webr-r}
# Pipe de magrittr (tidyverse)
atletas %>%
  filter(Posicion == "Mediocentro") %>%
  nrow()

# Pipe nativo de R 4.1+
atletas |>
  filter(Posicion == "Mediocentro") |>
  nrow()
```

**Diferencia principal:** `%>%` tiene m√°s funcionalidades (placeholder `.`), pero `|>` es m√°s r√°pido.

### Ejemplo 3.2: Uso del placeholder "."

El placeholder `.` representa el objeto que llega por el pipe:

```{webr-r}
# Usar el dato entrante en una posici√≥n espec√≠fica
atletas %>%
  filter(Posicion == "Delantero") %>%
  {cat("Hay", nrow(.), "delanteros\n")}
```

---

***

## 4. Method Chaining vs Pipe

### Comparaci√≥n directa

| Aspecto | Python (Pandas) | R (Tidyverse) |
|---------|-----------------|---------------|
| S√≠mbolo | `.` (punto) | `%>%` o `\|>` |
| Lectura | Izquierda a derecha | Izquierda a derecha |
| Salto de l√≠nea | Par√©ntesis externos | Pipe al final de l√≠nea |
| Asignaci√≥n | Variable al inicio | `<-` al inicio |

### Ejemplo 4.1: Patrones paralelos

**Python:**
```python
resultado = (
    atletas
    .query("Posicion == 'Defensa'")
    .assign(IMC = lambda x: x['Peso_kg'] / (x['Altura_cm']/100)**2)
    .nlargest(3, 'IMC')
)
```

**R:**
```{webr-r}
resultado <- atletas %>%
  filter(Posicion == "Defensa") %>%
  mutate(IMC = Peso_kg / (Altura_cm/100)^2) %>%
  slice_max(IMC, n = 3)

print(resultado)
```

---

### üß† Pr√°ctica 4.1: Pipeline completo

Crea un pipeline que:
1. Filtre mediocentros (Posicion == "Mediocentro")
2. Cree una columna `Aerobico_Score` = VO2max + YoYo_IR1_m/100
3. Ordene por Aerobico_Score descendente
4. Muestre las 3 primeras filas

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  filter(Posicion == "Mediocentro") %>%
  mutate(Aerobico_Score = VO2max + YoYo_IR1_m/100) %>%
  arrange(desc(Aerobico_Score)) %>%
  head(3)
```
:::

***

## 5. Buenas Pr√°cticas con Pipes

### ‚úÖ Hacer

```{webr-r}
# Cada operaci√≥n en su l√≠nea
atletas %>%
  filter(Edad < 30) %>%
  select(Nombre, Posicion, Edad) %>%
  arrange(Edad)
```

### ‚ùå Evitar

```r
# Todo en una l√≠nea (dif√≠cil de leer)
atletas %>% filter(Edad < 30) %>% select(Nombre, Posicion, Edad) %>% arrange(Edad)
```

### ‚úÖ Guardar resultados intermedios cuando sea √∫til

```{webr-r}
# Para depuraci√≥n o reutilizaci√≥n
jovenes <- atletas %>% filter(Edad < 25)
veteranos <- atletas %>% filter(Edad >= 30)

cat("J√≥venes:", nrow(jovenes), "\n")
cat("Veteranos:", nrow(veteranos), "\n")
```

---

***

## üèÜ Mini-Proyecto: An√°lisis con Pipelines

### Pregunta 1: Top Performers Aer√≥bicos
Crea un pipeline que encuentre los 5 atletas con mejor VO2max, mostrando nombre, posici√≥n y VO2max.

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  arrange(desc(VO2max)) %>%
  select(Nombre, Posicion, VO2max) %>%
  head(5)
```
:::

### Pregunta 2: An√°lisis por Posici√≥n
Usa un pipeline para contar cu√°ntos atletas hay en cada posici√≥n y ordenar de mayor a menor.

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
atletas %>%
  count(Posicion) %>%
  arrange(desc(n))
```
:::

### Pregunta 3: Perfil de Velocistas
Encuentra atletas con velocidad > 32 km/h, calcula su "Power Index" (Potencia_W * VelocidadMax_kmh / 1000), y muestra ordenados por este √≠ndice.

```{webr-r}
# Pista: A√±ade Potencia_W al dataset o usa los datos existentes

# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
# Primero a√±adimos Potencia_W al dataset
atletas_full <- atletas %>%
  mutate(Potencia_W = c(850, 780, 920, 950, 720, 810, 890, 700, 790, 880, 920, 680, 800, 860, 740))

atletas_full %>%
  filter(VelocidadMax_kmh > 32) %>%
  mutate(Power_Index = Potencia_W * VelocidadMax_kmh / 1000) %>%
  select(Nombre, Posicion, VelocidadMax_kmh, Power_Index) %>%
  arrange(desc(Power_Index))
```
:::

---

## Resumen

| Concepto | Python (Pandas) | R (Tidyverse) |
|----------|-----------------|---------------|
| Encadenamiento | `.method().method()` | `%>%` o `\|>` |
| Salto de l√≠nea | Par√©ntesis `()` | Pipe al final |
| Placeholder | `lambda x: x` | `.` (punto) |
| Asignaci√≥n | `resultado = (...` | `resultado <- ... %>%` |
