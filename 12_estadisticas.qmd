# Estad√≠sticas y Modelos

Este cap√≠tulo cubre an√°lisis estad√≠stico: correlaci√≥n, regresi√≥n, y modelos xG.

```{webr-r}
library(tidyverse)

# Dataset de tiros para modelo xG
set.seed(42)
n_tiros <- 200

tiros_modelo <- tibble(
  Distancia = runif(n_tiros, 5, 35),
  Angulo = runif(n_tiros, 5, 80),
  Tipo = sample(c("Pie", "Cabeza"), n_tiros, replace = TRUE, prob = c(0.8, 0.2)),
  Presion = sample(c("Alta", "Media", "Baja"), n_tiros, replace = TRUE, prob = c(0.3, 0.4, 0.3))
) %>%
  mutate(
    # Probabilidad real basada en variables
    prob_base = 0.5 - 0.015 * Distancia + 0.003 * Angulo,
    prob_ajustada = prob_base * if_else(Tipo == "Cabeza", 0.7, 1) * 
                    case_when(Presion == "Alta" ~ 0.8, Presion == "Media" ~ 1, TRUE ~ 1.1),
    prob_final = pmax(pmin(prob_ajustada + rnorm(n_tiros, 0, 0.05), 0.95), 0.02),
    Gol = rbinom(n_tiros, 1, prob_final)
  ) %>%
  select(-prob_base, -prob_ajustada, -prob_final)

# Dataset de atletas para correlaci√≥n
atletas <- tibble(
  Nombre = paste0("Jugador_", 1:30),
  VO2max = rnorm(30, 58, 5),
  YoYo_m = 1200 + 40 * rnorm(30, 58, 5) + rnorm(30, 0, 100),
  VelocidadMax = 28 + 0.1 * rnorm(30, 58, 5) + rnorm(30, 0, 1),
  Edad = sample(20:35, 30, replace = TRUE)
)

cat("‚úÖ Datos cargados\n")
cat("   tiros_modelo:", nrow(tiros_modelo), "\n")
cat("   atletas:", nrow(atletas), "\n")
```

***

## 1. Correlaci√≥n

### Ejemplo 1.1: Correlaci√≥n simple

```{webr-r}
cor(atletas$VO2max, atletas$YoYo_m)
```

### Ejemplo 1.2: Matriz de correlaci√≥n

```{webr-r}
atletas %>%
  select(VO2max, YoYo_m, VelocidadMax, Edad) %>%
  cor() %>%
  round(2)
```

### Ejemplo 1.3: Visualizar correlaciones

```{webr-r}
atletas %>%
  select(VO2max, YoYo_m, VelocidadMax, Edad) %>%
  cor() %>%
  as.data.frame() %>%
  rownames_to_column("Var1") %>%
  pivot_longer(-Var1, names_to = "Var2", values_to = "Correlacion") %>%
  ggplot(aes(x = Var1, y = Var2, fill = Correlacion)) +
  geom_tile() +
  geom_text(aes(label = round(Correlacion, 2)), color = "white") +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  labs(title = "Matriz de Correlaci√≥n")
```

---

***

## 2. Regresi√≥n Lineal

### Ejemplo 2.1: Modelo simple

```{webr-r}
modelo_lineal <- lm(YoYo_m ~ VO2max, data = atletas)
summary(modelo_lineal)
```

### Ejemplo 2.2: Visualizar regresi√≥n

```{webr-r}
ggplot(atletas, aes(x = VO2max, y = YoYo_m)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Regresi√≥n: YoYo ~ VO2max",
       x = "VO2max (ml/kg/min)", y = "YoYo IR1 (m)") +
  theme_minimal()
```

---

***

## 3. Regresi√≥n Log√≠stica (Modelo xG)

### Ejemplo 3.1: Modelo xG b√°sico

```{webr-r}
# Convertir variables categ√≥ricas a dummies
modelo_xg <- glm(Gol ~ Distancia + Angulo + Tipo + Presion, 
                 data = tiros_modelo, family = binomial)

summary(modelo_xg)
```

### Ejemplo 3.2: Predicciones (xG)

```{webr-r}
tiros_modelo <- tiros_modelo %>%
  mutate(xG = predict(modelo_xg, type = "response"))

# Ver primeras predicciones
tiros_modelo %>%
  select(Distancia, Angulo, Tipo, Gol, xG) %>%
  head(10)
```

### Ejemplo 3.3: Evaluar modelo

```{webr-r}
# Comparar xG predicho vs goles reales
cat("xG total predicho:", round(sum(tiros_modelo$xG), 1), "\n")
cat("Goles reales:", sum(tiros_modelo$Gol), "\n")

# Visualizar calibraci√≥n
tiros_modelo %>%
  mutate(xG_bin = cut(xG, breaks = seq(0, 1, 0.1))) %>%
  group_by(xG_bin) %>%
  summarise(
    xG_medio = mean(xG),
    Conversion_real = mean(Gol),
    n = n()
  ) %>%
  ggplot(aes(x = xG_medio, y = Conversion_real)) +
  geom_point(aes(size = n)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Calibraci√≥n del Modelo xG",
       x = "xG Predicho", y = "Conversi√≥n Real") +
  theme_minimal()
```

---

***

## üèÜ Mini-Proyecto: Modelo xG Personalizado

### Pregunta 1: Efecto de la Distancia
¬øC√≥mo afecta la distancia a la probabilidad de gol? Visual√≠zalo.

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
# Crear predicciones para diferentes distancias
predicciones <- tibble(
  Distancia = seq(5, 35, 1),
  Angulo = 45,
  Tipo = "Pie",
  Presion = "Media"
)

predicciones$xG <- predict(modelo_xg, newdata = predicciones, type = "response")

ggplot(predicciones, aes(x = Distancia, y = xG)) +
  geom_line(color = "steelblue", size = 1.5) +
  labs(title = "xG vs Distancia al Arco",
       x = "Distancia (m)", y = "xG") +
  theme_minimal()
```
:::

### Pregunta 2: Top Tiros por Diferencia xG
Encuentra los 5 tiros donde el jugador "sobreperform√≥" m√°s (Gol con xG bajo).

```{webr-r}
# Escribe tu c√≥digo aqu√≠:


```

::: {.callout-tip collapse="true"}
## Ver soluci√≥n
```r
tiros_modelo %>%
  filter(Gol == 1) %>%
  arrange(xG) %>%
  head(5) %>%
  select(Distancia, Angulo, Tipo, xG)
```
:::

---

## Resumen

| An√°lisis | Funci√≥n R |
|----------|-----------|
| Correlaci√≥n | `cor()` |
| Regresi√≥n lineal | `lm()` |
| Regresi√≥n log√≠stica | `glm(family = binomial)` |
| Predicciones | `predict()` |
| Resumen modelo | `summary()` |
